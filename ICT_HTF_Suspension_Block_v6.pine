//@version=6
indicator("ICT HTF Suspension Block [v6] - DEBUG", overlay = true, max_boxes_count = 500, max_lines_count = 500, max_labels_count = 500)

// ==================== INPUTS ====================
string GRP_HTF = "â•â•â• Higher Timeframe Settings â•â•â•"
string htf_period    = input.timeframe("240", "Higher Timeframe (HTF)", group = GRP_HTF)
int    blocks_to_show = input.int(5, "Number of Blocks to Display", minval = 1, maxval = 20, group = GRP_HTF)
int    extend_bars   = input.int(50, "Extend Blocks (bars)", minval = 5, maxval = 200, group = GRP_HTF)

string GRP_DETECTION = "â•â•â• Detection Settings â•â•â•"
string detect_mode   = input.string("Wick-to-Wick (Common)", "Detection Mode", options = ["True Gaps Only (Rare)", "Wick-to-Wick (Common)", "Body-to-Body (Most Common)"], group = GRP_DETECTION, tooltip = "True Gaps: Actual price gaps (rare in 24/7 markets)\nWick-to-Wick: Candle wicks don't overlap (more common)\nBody-to-Body: Candle bodies don't overlap (most common)")

string GRP_COLORS = "â•â•â• Colors â•â•â•"
color  sb_bull_col   = input.color(color.new(#00ff88, 75), "Bullish SB Fill", group = GRP_COLORS)
color  sb_bear_col   = input.color(color.new(#ff3d5d, 75), "Bearish SB Fill", group = GRP_COLORS)
color  vi_bull_col   = input.color(color.new(#00ff88, 85), "Bullish VI Zone Fill", group = GRP_COLORS)
color  vi_bear_col   = input.color(color.new(#ff3d5d, 85), "Bearish VI Zone Fill", group = GRP_COLORS)
color  quad_col      = input.color(color.new(color.white, 40), "Quadrant Lines", group = GRP_COLORS)
color  entry_col     = input.color(color.new(#00bfff, 0), "Entry Line Color", group = GRP_COLORS)
color  sl_col        = input.color(color.new(#ff4444, 0), "Stop Loss Color", group = GRP_COLORS)
color  tp_col        = input.color(color.new(#44ff44, 0), "Take Profit Color", group = GRP_COLORS)

string GRP_FEATURES = "â•â•â• Features â•â•â•"
bool   show_vi       = input.bool(true, "Show Volume Imbalance Zones", group = GRP_FEATURES)
bool   show_quadrants = input.bool(true, "Show Quadrant Lines (25/50/75%)", group = GRP_FEATURES)
bool   show_mss      = input.bool(true, "Show MSS Signals", group = GRP_FEATURES)
bool   show_trade_levels = input.bool(true, "Show Entry/SL/TP on MSS", group = GRP_FEATURES)
bool   show_zone_alerts  = input.bool(true, "Alert on Optimal Zone Entry", group = GRP_FEATURES)
bool   show_sb_label = input.bool(true, "Show SB Label on Detection", group = GRP_FEATURES)
bool   show_debug    = input.bool(true, "Show Debug Table", group = GRP_FEATURES)

string GRP_KILLZONE = "â•â•â• Kill Zone Filter â•â•â•"
bool   use_killzones = input.bool(false, "Only Show MSS During Kill Zones", group = GRP_KILLZONE)
bool   kz_asian      = input.bool(false, "Asian Session (20:00-00:00 NY)", group = GRP_KILLZONE)
bool   kz_london     = input.bool(true, "London Session (02:00-05:00 NY)", group = GRP_KILLZONE)
bool   kz_ny_am      = input.bool(true, "NY AM Session (07:00-10:00 NY)", group = GRP_KILLZONE)
bool   kz_ny_pm      = input.bool(false, "NY PM Session (13:30-16:00 NY)", group = GRP_KILLZONE)

// ==================== KILL ZONE LOGIC ====================
ny_hour = hour(time, "America/New_York")
ny_minute = minute(time, "America/New_York")
ny_time_decimal = ny_hour + ny_minute / 60.0

bool in_asian_kz  = kz_asian and (ny_time_decimal >= 20.0 or ny_time_decimal < 0.0)
bool in_london_kz = kz_london and (ny_time_decimal >= 2.0 and ny_time_decimal < 5.0)
bool in_ny_am_kz  = kz_ny_am and (ny_time_decimal >= 7.0 and ny_time_decimal < 10.0)
bool in_ny_pm_kz  = kz_ny_pm and (ny_time_decimal >= 13.5 and ny_time_decimal < 16.0)

bool in_any_killzone = in_asian_kz or in_london_kz or in_ny_am_kz or in_ny_pm_kz
bool killzone_filter_passed = not use_killzones or in_any_killzone

// ==================== HTF DATA EXTRACTION ====================
// Get data for 3 consecutive HTF candles
htf_data() =>
    [high[2], low[2], open[2], close[2], 
     high[1], low[1], open[1], close[1], 
     high[0], low[0], open[0], close[0],
     time[1], bar_index]

[htf_h2, htf_l2, htf_o2, htf_c2, 
 htf_h1, htf_l1, htf_o1, htf_c1, 
 htf_h0, htf_l0, htf_o0, htf_c0,
 htf_time1, htf_bar] = request.security(syminfo.tickerid, htf_period, htf_data(), lookahead = barmerge.lookahead_off)

// Calculate body tops and bottoms
float body_top_2 = math.max(htf_o2, htf_c2)
float body_bot_2 = math.min(htf_o2, htf_c2)
float body_top_1 = math.max(htf_o1, htf_c1)
float body_bot_1 = math.min(htf_o1, htf_c1)
float body_top_0 = math.max(htf_o0, htf_c0)
float body_bot_0 = math.min(htf_o0, htf_c0)

// ==================== SUSPENSION BLOCK DETECTION ====================
// Three detection modes based on how strict the "gap" requirement is

bool bullish_sb_detected = false
bool bearish_sb_detected = false

// Volume imbalance zone boundaries
float vi_lower_top = na  // Lower gap (below SB)
float vi_lower_bot = na
float vi_upper_top = na  // Upper gap (above SB)
float vi_upper_bot = na

if detect_mode == "True Gaps Only (Rare)"
    // Strictest: Actual price gaps (wicks don't touch)
    // Bullish: High[2] < Low[1] AND High[1] < Low[0]
    bullish_sb_detected := not na(htf_h2) and not na(htf_l1) and not na(htf_h1) and not na(htf_l0) and 
                           (htf_h2 < htf_l1) and (htf_h1 < htf_l0)
    // Bearish: Low[2] > High[1] AND Low[1] > High[0]
    bearish_sb_detected := not na(htf_l2) and not na(htf_h1) and not na(htf_l1) and not na(htf_h0) and 
                           (htf_l2 > htf_h1) and (htf_l1 > htf_h0)
    
    if bullish_sb_detected
        vi_lower_top := htf_l1
        vi_lower_bot := htf_h2
        vi_upper_top := htf_l0
        vi_upper_bot := htf_h1
    if bearish_sb_detected
        vi_upper_top := htf_l2
        vi_upper_bot := htf_h1
        vi_lower_top := htf_l1
        vi_lower_bot := htf_h0

else if detect_mode == "Wick-to-Wick (Common)"
    // Medium: Wicks can touch but not overlap significantly
    // Bullish: High[2] <= Low[1] AND High[1] <= Low[0] (allows touching)
    bullish_sb_detected := not na(htf_h2) and not na(htf_l1) and not na(htf_h1) and not na(htf_l0) and 
                           (htf_h2 <= htf_l1) and (htf_h1 <= htf_l0)
    // Bearish: Low[2] >= High[1] AND Low[1] >= High[0]
    bearish_sb_detected := not na(htf_l2) and not na(htf_h1) and not na(htf_l1) and not na(htf_h0) and 
                           (htf_l2 >= htf_h1) and (htf_l1 >= htf_h0)
    
    if bullish_sb_detected
        vi_lower_top := htf_l1
        vi_lower_bot := htf_h2
        vi_upper_top := htf_l0
        vi_upper_bot := htf_h1
    if bearish_sb_detected
        vi_upper_top := htf_l2
        vi_upper_bot := htf_h1
        vi_lower_top := htf_l1
        vi_lower_bot := htf_h0

else if detect_mode == "Body-to-Body (Most Common)"
    // Loosest: Bodies don't overlap (wicks can overlap)
    // This is more like a traditional FVG detection
    // Bullish: Body_Top[2] < Body_Bot[1] AND Body_Top[1] < Body_Bot[0]
    bullish_sb_detected := not na(body_top_2) and not na(body_bot_1) and not na(body_top_1) and not na(body_bot_0) and 
                           (body_top_2 < body_bot_1) and (body_top_1 < body_bot_0)
    // Bearish: Body_Bot[2] > Body_Top[1] AND Body_Bot[1] > Body_Top[0]
    bearish_sb_detected := not na(body_bot_2) and not na(body_top_1) and not na(body_bot_1) and not na(body_top_0) and 
                           (body_bot_2 > body_top_1) and (body_bot_1 > body_top_0)
    
    if bullish_sb_detected
        vi_lower_top := body_bot_1
        vi_lower_bot := body_top_2
        vi_upper_top := body_bot_0
        vi_upper_bot := body_top_1
    if bearish_sb_detected
        vi_upper_top := body_bot_2
        vi_upper_bot := body_top_1
        vi_lower_top := body_bot_1
        vi_lower_bot := body_top_0

// Track HTF bar changes
var int last_htf_bar = 0
bool is_new_htf_bar = htf_bar != last_htf_bar and not na(htf_bar)

if is_new_htf_bar
    last_htf_bar := htf_bar

// ==================== STORAGE ARRAYS ====================
var array<box> sb_boxes = array.new_box()
var array<line> ce_lines = array.new_line()
var array<line> uq_lines = array.new_line()
var array<line> lq_lines = array.new_line()
var array<box> vi_upper_boxes = array.new_box()
var array<box> vi_lower_boxes = array.new_box()
var array<label> sb_labels = array.new_label()
var array<bool> sb_is_bull = array.new_bool()

var array<line> entry_lines = array.new_line()
var array<line> sl_lines = array.new_line()
var array<line> tp1_lines = array.new_line()
var array<line> tp2_lines = array.new_line()
var array<line> tp3_lines = array.new_line()
var array<label> trade_labels = array.new_label()

// Current active SB levels
var float active_sb_high = na
var float active_sb_low = na
var float active_sb_ce = na
var float active_sb_uq = na
var float active_sb_lq = na
var bool active_sb_is_bull = true
var float active_vi_upper_top = na
var float active_vi_upper_bot = na
var float active_vi_lower_top = na
var float active_vi_lower_bot = na

var bool was_in_buy_zone = false
var bool was_in_sell_zone = false

// Debug counters
var int total_sb_detected = 0

// ==================== DRAW SUSPENSION BLOCK ====================
if is_new_htf_bar and (bullish_sb_detected or bearish_sb_detected)
    total_sb_detected += 1
    
    float sb_high = htf_h1
    float sb_low = htf_l1
    float sb_open = htf_o1
    float sb_close = htf_c1
    
    float range_size = sb_high - sb_low
    float ce_level = sb_low + (range_size * 0.5)
    float upper_quad = sb_low + (range_size * 0.75)
    float lower_quad = sb_low + (range_size * 0.25)
    
    // Update active SB levels
    active_sb_high := sb_high
    active_sb_low := sb_low
    active_sb_ce := ce_level
    active_sb_uq := upper_quad
    active_sb_lq := lower_quad
    active_sb_is_bull := bullish_sb_detected
    active_vi_upper_top := vi_upper_top
    active_vi_upper_bot := vi_upper_bot
    active_vi_lower_top := vi_lower_top
    active_vi_lower_bot := vi_lower_bot
    
    was_in_buy_zone := false
    was_in_sell_zone := false
    
    color sb_color = bullish_sb_detected ? sb_bull_col : sb_bear_col
    color vi_color = bullish_sb_detected ? vi_bull_col : vi_bear_col
    
    // Draw Suspension Block
    box new_sb = box.new(bar_index, sb_high, bar_index + extend_bars, sb_low,
                         bgcolor = sb_color,
                         border_color = color.new(sb_color, 0),
                         border_width = 2)
    array.push(sb_boxes, new_sb)
    array.push(sb_is_bull, bullish_sb_detected)
    
    // Draw Volume Imbalance zones
    if show_vi
        if not na(vi_upper_top) and not na(vi_upper_bot) and vi_upper_top > vi_upper_bot
            box new_vi_upper = box.new(bar_index, vi_upper_top, bar_index + extend_bars, vi_upper_bot,
                                       bgcolor = vi_color, border_width = 0)
            array.push(vi_upper_boxes, new_vi_upper)
        
        if not na(vi_lower_top) and not na(vi_lower_bot) and vi_lower_top > vi_lower_bot
            box new_vi_lower = box.new(bar_index, vi_lower_top, bar_index + extend_bars, vi_lower_bot,
                                       bgcolor = vi_color, border_width = 0)
            array.push(vi_lower_boxes, new_vi_lower)
    
    // Draw quadrant lines
    if show_quadrants
        line new_ce = line.new(bar_index, ce_level, bar_index + extend_bars, ce_level,
                               color = quad_col, style = line.style_dashed, width = 2)
        line new_uq = line.new(bar_index, upper_quad, bar_index + extend_bars, upper_quad,
                               color = quad_col, style = line.style_dotted, width = 1)
        line new_lq = line.new(bar_index, lower_quad, bar_index + extend_bars, lower_quad,
                               color = quad_col, style = line.style_dotted, width = 1)
        array.push(ce_lines, new_ce)
        array.push(uq_lines, new_uq)
        array.push(lq_lines, new_lq)
    
    // Draw SB label
    if show_sb_label
        string sb_text = bullish_sb_detected ? "â–² Bull SB" : "â–¼ Bear SB"
        color lbl_color = bullish_sb_detected ? color.green : color.red
        label new_lbl = label.new(bar_index, bullish_sb_detected ? sb_low : sb_high, sb_text,
                                  style = bullish_sb_detected ? label.style_label_up : label.style_label_down,
                                  color = lbl_color, textcolor = color.white, size = size.normal)
        array.push(sb_labels, new_lbl)
    
    // Alert
    if bullish_sb_detected
        alert("ðŸŸ¢ BULLISH SUSPENSION BLOCK DETECTED\nHTF: " + htf_period + " | Mode: " + detect_mode + 
              "\nHigh: " + str.tostring(sb_high, format.mintick) + 
              "\nCE: " + str.tostring(ce_level, format.mintick) + 
              "\nLow: " + str.tostring(sb_low, format.mintick), alert.freq_once_per_bar)
    else
        alert("ðŸ”´ BEARISH SUSPENSION BLOCK DETECTED\nHTF: " + htf_period + " | Mode: " + detect_mode + 
              "\nHigh: " + str.tostring(sb_high, format.mintick) + 
              "\nCE: " + str.tostring(ce_level, format.mintick) + 
              "\nLow: " + str.tostring(sb_low, format.mintick), alert.freq_once_per_bar)
    
    // Cleanup old blocks
    while array.size(sb_boxes) > blocks_to_show
        box.delete(array.shift(sb_boxes))
        array.shift(sb_is_bull)
    while array.size(ce_lines) > blocks_to_show
        line.delete(array.shift(ce_lines))
    while array.size(uq_lines) > blocks_to_show
        line.delete(array.shift(uq_lines))
    while array.size(lq_lines) > blocks_to_show
        line.delete(array.shift(lq_lines))
    while array.size(vi_upper_boxes) > blocks_to_show
        box.delete(array.shift(vi_upper_boxes))
    while array.size(vi_lower_boxes) > blocks_to_show
        box.delete(array.shift(vi_lower_boxes))
    while array.size(sb_labels) > blocks_to_show
        label.delete(array.shift(sb_labels))

// ==================== EXTEND BLOCKS ====================
if array.size(sb_boxes) > 0
    int right_edge = bar_index + 5
    
    for i = 0 to array.size(sb_boxes) - 1
        array.get(sb_boxes, i).set_right(right_edge)
    
    if show_quadrants
        for i = 0 to math.min(array.size(ce_lines) - 1, array.size(sb_boxes) - 1)
            array.get(ce_lines, i).set_x2(right_edge)
        for i = 0 to math.min(array.size(uq_lines) - 1, array.size(sb_boxes) - 1)
            array.get(uq_lines, i).set_x2(right_edge)
        for i = 0 to math.min(array.size(lq_lines) - 1, array.size(sb_boxes) - 1)
            array.get(lq_lines, i).set_x2(right_edge)
    
    if show_vi
        for i = 0 to array.size(vi_upper_boxes) - 1
            array.get(vi_upper_boxes, i).set_right(right_edge)
        for i = 0 to array.size(vi_lower_boxes) - 1
            array.get(vi_lower_boxes, i).set_right(right_edge)

// ==================== BIAS & ZONE LOGIC ====================
bool is_discount = not na(active_sb_ce) and close < active_sb_ce
bool is_premium  = not na(active_sb_ce) and close > active_sb_ce

bool in_buy_zone = false
bool in_sell_zone = false

if not na(active_sb_lq) and not na(active_sb_uq)
    if active_sb_is_bull
        in_buy_zone := close <= active_sb_lq or (not na(active_vi_lower_top) and close <= active_vi_lower_top and close >= active_vi_lower_bot)
    else
        in_sell_zone := close >= active_sb_uq or (not na(active_vi_upper_top) and close >= active_vi_upper_bot and close <= active_vi_upper_top)

// Zone alerts
bool entered_buy_zone  = in_buy_zone and not was_in_buy_zone
bool entered_sell_zone = in_sell_zone and not was_in_sell_zone

if show_zone_alerts and entered_buy_zone and active_sb_is_bull
    alert("ðŸŸ¢ BUY ZONE: Price entered optimal zone in BULLISH SB!", alert.freq_once_per_bar)

if show_zone_alerts and entered_sell_zone and not active_sb_is_bull
    alert("ðŸ”´ SELL ZONE: Price entered optimal zone in BEARISH SB!", alert.freq_once_per_bar)

was_in_buy_zone := in_buy_zone
was_in_sell_zone := in_sell_zone

// ==================== MSS LOGIC ====================
float swing_high = ta.highest(high, 5)
float swing_low  = ta.lowest(low, 5)

bool raw_mss_bull = active_sb_is_bull and is_discount and ta.crossover(close, swing_high[1])
bool raw_mss_bear = not active_sb_is_bull and is_premium and ta.crossunder(close, swing_low[1])

bool mss_bull = show_mss and raw_mss_bull and killzone_filter_passed and not na(active_sb_ce)
bool mss_bear = show_mss and raw_mss_bear and killzone_filter_passed and not na(active_sb_ce)

// ==================== TRADE LEVELS ====================
clean_trade_levels() =>
    while array.size(entry_lines) > 5
        line.delete(array.shift(entry_lines))
    while array.size(sl_lines) > 5
        line.delete(array.shift(sl_lines))
    while array.size(tp1_lines) > 5
        line.delete(array.shift(tp1_lines))
    while array.size(tp2_lines) > 5
        line.delete(array.shift(tp2_lines))
    while array.size(tp3_lines) > 5
        line.delete(array.shift(tp3_lines))
    while array.size(trade_labels) > 10
        label.delete(array.shift(trade_labels))

if mss_bull and show_trade_levels
    int lvl_start = bar_index
    int lvl_end = bar_index + 30
    
    float entry_price = close
    float sl_price = na(active_vi_lower_bot) ? active_sb_low - (syminfo.mintick * 10) : active_vi_lower_bot - (syminfo.mintick * 10)
    float tp1_price = active_sb_ce
    float tp2_price = active_sb_uq
    float tp3_price = na(active_vi_upper_top) ? active_sb_high : active_vi_upper_top
    
    array.push(entry_lines, line.new(lvl_start, entry_price, lvl_end, entry_price, color = entry_col, style = line.style_solid, width = 2))
    array.push(sl_lines, line.new(lvl_start, sl_price, lvl_end, sl_price, color = sl_col, style = line.style_solid, width = 2))
    array.push(tp1_lines, line.new(lvl_start, tp1_price, lvl_end, tp1_price, color = tp_col, style = line.style_dashed, width = 1))
    array.push(tp3_lines, line.new(lvl_start, tp3_price, lvl_end, tp3_price, color = tp_col, style = line.style_solid, width = 2))
    
    array.push(trade_labels, label.new(lvl_end, entry_price, "ENTRY", style = label.style_label_left, color = entry_col, textcolor = color.white, size = size.small))
    array.push(trade_labels, label.new(lvl_end, sl_price, "SL", style = label.style_label_left, color = sl_col, textcolor = color.white, size = size.small))
    array.push(trade_labels, label.new(lvl_end, tp1_price, "TP1", style = label.style_label_left, color = tp_col, textcolor = color.white, size = size.small))
    array.push(trade_labels, label.new(lvl_end, tp3_price, "TP3", style = label.style_label_left, color = tp_col, textcolor = color.white, size = size.small))
    
    clean_trade_levels()
    
    float risk = entry_price - sl_price
    float reward = tp1_price - entry_price
    float rr = risk > 0 ? reward / risk : 0
    
    alert("ðŸŸ¢ LONG MSS\nEntry: " + str.tostring(entry_price, format.mintick) + 
          "\nSL: " + str.tostring(sl_price, format.mintick) + 
          "\nTP1: " + str.tostring(tp1_price, format.mintick) + 
          "\nR:R: " + str.tostring(rr, "#.##"), alert.freq_once_per_bar)

if mss_bear and show_trade_levels
    int lvl_start = bar_index
    int lvl_end = bar_index + 30
    
    float entry_price = close
    float sl_price = na(active_vi_upper_top) ? active_sb_high + (syminfo.mintick * 10) : active_vi_upper_top + (syminfo.mintick * 10)
    float tp1_price = active_sb_ce
    float tp3_price = na(active_vi_lower_bot) ? active_sb_low : active_vi_lower_bot
    
    array.push(entry_lines, line.new(lvl_start, entry_price, lvl_end, entry_price, color = entry_col, style = line.style_solid, width = 2))
    array.push(sl_lines, line.new(lvl_start, sl_price, lvl_end, sl_price, color = sl_col, style = line.style_solid, width = 2))
    array.push(tp1_lines, line.new(lvl_start, tp1_price, lvl_end, tp1_price, color = tp_col, style = line.style_dashed, width = 1))
    array.push(tp3_lines, line.new(lvl_start, tp3_price, lvl_end, tp3_price, color = tp_col, style = line.style_solid, width = 2))
    
    array.push(trade_labels, label.new(lvl_end, entry_price, "ENTRY", style = label.style_label_left, color = entry_col, textcolor = color.white, size = size.small))
    array.push(trade_labels, label.new(lvl_end, sl_price, "SL", style = label.style_label_left, color = sl_col, textcolor = color.white, size = size.small))
    array.push(trade_labels, label.new(lvl_end, tp1_price, "TP1", style = label.style_label_left, color = tp_col, textcolor = color.white, size = size.small))
    array.push(trade_labels, label.new(lvl_end, tp3_price, "TP3", style = label.style_label_left, color = tp_col, textcolor = color.white, size = size.small))
    
    clean_trade_levels()
    
    float risk = sl_price - entry_price
    float reward = entry_price - tp1_price
    float rr = risk > 0 ? reward / risk : 0
    
    alert("ðŸ”´ SHORT MSS\nEntry: " + str.tostring(entry_price, format.mintick) + 
          "\nSL: " + str.tostring(sl_price, format.mintick) + 
          "\nTP1: " + str.tostring(tp1_price, format.mintick) + 
          "\nR:R: " + str.tostring(rr, "#.##"), alert.freq_once_per_bar)

// ==================== MSS SHAPES ====================
plotshape(mss_bull, "Bullish MSS", shape.labelup, location.belowbar, color.green, text="MSS", textcolor=color.white, size=size.small)
plotshape(mss_bear, "Bearish MSS", shape.labeldown, location.abovebar, color.red, text="MSS", textcolor=color.white, size=size.small)

plotshape(show_mss and raw_mss_bull and not killzone_filter_passed, "Filtered Bull MSS", shape.labelup, location.belowbar, color.new(color.gray, 50), text="mss", textcolor=color.gray, size=size.tiny)
plotshape(show_mss and raw_mss_bear and not killzone_filter_passed, "Filtered Bear MSS", shape.labeldown, location.abovebar, color.new(color.gray, 50), text="mss", textcolor=color.gray, size=size.tiny)

// ==================== DEBUG TABLE ====================
var table debug_board = table.new(position.bottom_left, 2, 8, border_width = 1)

if show_debug and barstate.islast
    table.cell(debug_board, 0, 0, "DEBUG INFO", bgcolor = color.purple, text_color = color.white)
    table.cell(debug_board, 1, 0, htf_period + " HTF", bgcolor = color.purple, text_color = color.white)
    
    table.cell(debug_board, 0, 1, "Detection Mode", bgcolor = color.new(color.gray, 20), text_color = color.white)
    table.cell(debug_board, 1, 1, detect_mode, bgcolor = color.black, text_color = color.yellow)
    
    table.cell(debug_board, 0, 2, "Total SBs Found", bgcolor = color.new(color.gray, 20), text_color = color.white)
    table.cell(debug_board, 1, 2, str.tostring(total_sb_detected), bgcolor = color.black, text_color = color.white)
    
    table.cell(debug_board, 0, 3, "HTF H[2]", bgcolor = color.new(color.gray, 20), text_color = color.white)
    table.cell(debug_board, 1, 3, str.tostring(htf_h2, format.mintick), bgcolor = color.black, text_color = color.white)
    
    table.cell(debug_board, 0, 4, "HTF L[1] (SB Low)", bgcolor = color.new(color.gray, 20), text_color = color.white)
    table.cell(debug_board, 1, 4, str.tostring(htf_l1, format.mintick), bgcolor = color.black, text_color = color.white)
    
    table.cell(debug_board, 0, 5, "HTF H[1] (SB High)", bgcolor = color.new(color.gray, 20), text_color = color.white)
    table.cell(debug_board, 1, 5, str.tostring(htf_h1, format.mintick), bgcolor = color.black, text_color = color.white)
    
    table.cell(debug_board, 0, 6, "HTF L[0]", bgcolor = color.new(color.gray, 20), text_color = color.white)
    table.cell(debug_board, 1, 6, str.tostring(htf_l0, format.mintick), bgcolor = color.black, text_color = color.white)
    
    // Show gap check
    string gap_status = "H[2]<L[1]: " + str.tostring(htf_h2 < htf_l1) + " | H[1]<L[0]: " + str.tostring(htf_h1 < htf_l0)
    table.cell(debug_board, 0, 7, "Bull Gap Check", bgcolor = color.new(color.gray, 20), text_color = color.white)
    table.cell(debug_board, 1, 7, gap_status, bgcolor = color.black, text_color = htf_h2 < htf_l1 and htf_h1 < htf_l0 ? color.green : color.red)

// ==================== MAIN DASHBOARD ====================
var table board = table.new(position.top_right, 2, 8, border_width = 1)

if barstate.islast
    string tf_display = htf_period == "D" ? "Daily" : htf_period == "W" ? "Weekly" : htf_period == "M" ? "Monthly" : htf_period == "240" ? "4H" : htf_period == "60" ? "1H" : htf_period + "m"
    
    string kz_status = not use_killzones ? "OFF" : in_london_kz ? "LONDON" : in_ny_am_kz ? "NY AM" : in_ny_pm_kz ? "NY PM" : in_asian_kz ? "ASIAN" : "WAITING"
    color kz_color = not use_killzones ? color.gray : in_any_killzone ? color.blue : color.new(color.gray, 50)
    
    string sb_type = na(active_sb_ce) ? "NONE" : active_sb_is_bull ? "BULLISH" : "BEARISH"
    color sb_type_col = na(active_sb_ce) ? color.gray : active_sb_is_bull ? color.green : color.red
    
    table.cell(board, 0, 0, tf_display + " SB", bgcolor = color.gray, text_color = color.white)
    table.cell(board, 1, 0, sb_type, bgcolor = sb_type_col, text_color = color.white)
    
    string pos_txt = na(active_sb_ce) ? "N/A" : is_premium ? "PREMIUM" : "DISCOUNT"
    color pos_col = na(active_sb_ce) ? color.gray : is_premium ? color.red : color.green
    table.cell(board, 0, 1, "POSITION", bgcolor = color.new(color.gray, 20), text_color = color.white)
    table.cell(board, 1, 1, pos_txt, bgcolor = pos_col, text_color = color.white)
    
    table.cell(board, 0, 2, "KILL ZONE", bgcolor = color.new(color.gray, 20), text_color = color.white)
    table.cell(board, 1, 2, kz_status, bgcolor = kz_color, text_color = color.white)
    
    table.cell(board, 0, 3, "SB HIGH", bgcolor = color.new(color.gray, 20), text_color = color.white)
    table.cell(board, 1, 3, na(active_sb_high) ? "N/A" : str.tostring(active_sb_high, format.mintick), bgcolor = color.black, text_color = color.white)
    
    table.cell(board, 0, 4, "CE (50%)", bgcolor = color.new(color.gray, 20), text_color = color.white)
    table.cell(board, 1, 4, na(active_sb_ce) ? "N/A" : str.tostring(active_sb_ce, format.mintick), bgcolor = color.black, text_color = color.white)
    
    table.cell(board, 0, 5, "SB LOW", bgcolor = color.new(color.gray, 20), text_color = color.white)
    table.cell(board, 1, 5, na(active_sb_low) ? "N/A" : str.tostring(active_sb_low, format.mintick), bgcolor = color.black, text_color = color.white)
    
    float block_range = not na(active_sb_high) and not na(active_sb_low) ? active_sb_high - active_sb_low : na
    table.cell(board, 0, 6, "RANGE", bgcolor = color.new(color.gray, 20), text_color = color.white)
    table.cell(board, 1, 6, na(block_range) ? "N/A" : str.tostring(block_range, format.mintick), bgcolor = color.black, text_color = color.white)
    
    string status_txt = "WAITING"
    color status_col = color.gray
    
    if na(active_sb_ce)
        status_txt := "NO SB"
        status_col := color.gray
    else if in_buy_zone and active_sb_is_bull
        status_txt := "ðŸŽ¯ BUY ZONE"
        status_col := color.green
    else if in_sell_zone and not active_sb_is_bull
        status_txt := "ðŸŽ¯ SELL ZONE"
        status_col := color.red
    else if is_discount and active_sb_is_bull
        status_txt := "DISCOUNT"
        status_col := color.new(color.green, 50)
    else if is_premium and not active_sb_is_bull
        status_txt := "PREMIUM"
        status_col := color.new(color.red, 50)
    else
        status_txt := "NEUTRAL"
        status_col := color.gray
    
    table.cell(board, 0, 7, "STATUS", bgcolor = color.new(color.gray, 20), text_color = color.white)
    table.cell(board, 1, 7, status_txt, bgcolor = status_col, text_color = color.white)
